[下载地址](https://github.com/robfig/cron)

[doc](https://pkg.go.dev/github.com/robfig/cron)

```bash
go get github.com/robfig/cron/v3@v3.0.0
```

# 介绍

用过 linux 的应该对 cron 有所了解。linux 中可以通过 crontab -e 来配置定时任务。不过，linux 中的 cron 只能精确到分钟。而我们这里要讨论的 Go 实现的 cron 可以精确到秒，除了这点比较大的区别外，cron 表达式的基本语法是类似的。（如果使用过 Java 中的 Quartz，对 cron 表达式应该比较了解，而且它和这里我们将要讨论的 Go 版 cron 很像，也都精确到秒） cron(计划任务)，顾名思义，按照约定的时间，定时的执行特定的任务（job）。cron 表达式 表达了这种约定。 cron 表达式代表了一个时间集合，使用 6 个空格分隔的字段表示。

# Cron表达式

## 表达式字段

> 使用 `cron.New(cron.WithSeconds())` 开启秒字段支持

| 字段                           | 必填 | 取值范围        | 特殊字符    |
| ------------------------------ | ---- | --------------- | ----------- |
| 秒（Seconds）                  | 是   | 0–59            | `* / , -`   |
| 分（Minutes）                  | 是   | 0–59            | `* / , -`   |
| 小时（Hours）                  | 是   | 0–23            | `* / , -`   |
| 一月中的某一天（Day of month） | 是   | 1–31            | `* / , - ?` |
| 月（Month）                    | 是   | 1–12 or JAN–DEC | `* / , -`   |
| 星期几（Day of week）          | 是   | 0–6 or SUN–SAT  | `* / , - ?` |

> 月(Month)和星期(Day of week)字段的值不区分大小写，如：SUN、Sun 和 sun 是一样的。 2）星期 (Day of week)字段如果没提供，相当于是 *

## 特殊字符

- **星号（`*`）**
  星号表示匹配该字段的所有值，如在上面表达式的天位置中使用星号，就表示每天。
- **斜线（`/`）**
  斜杠用于描述范围的增量，比如'3-59/15'这个表达式在表示从现在的第三分钟开始和往后的每15分钟，到第59分钟为止。表现形式为"* \ / ..."，等同于"N-MAX / m"，即在该字段范围内的增量。即从N开始，使用增量 m 直到 MAX 结束，它没有重复
- **逗号（`,`）**
  逗号用于分隔列表中的项，比如，在上表的'星期几'中使用 "MON,WED,FRI" 表示星期一、星期三和星期五
- **连字符（`-`）**
  连字符用于定义范围。例如，9-17表示包括上午9点至下午5点在内的每小时
- **问号 （`?`）**
  表示不指定值，可以来代替 `*`

## 预定义表达式

| 表达式                   | 描述                                                    | 等式            |
| ------------------------ | ------------------------------------------------------- | --------------- |
| `@yearly (or @annually)` | 每年1月1日 00:00:00 执行一次                            | `0 0 0 1 1 *`   |
| `@monthly`               | 每个月第一天的 00:00:00 执行一次                        | `0 0 0 1 * *`   |
| `@weekly`                | 每周周六的 00:00:00 执行一次                            | `0 0 0 * * 0`   |
| `@daily (or @midnight)`  | 每天 00:00:00 执行一次                                  | `0 0 0 * * *`   |
| `@hourly`                | 每小时执行一次                                          | `0 0 * * * *`   |
| `@every time`            | 指定时间间隔执行一次，如 `@every 5s`，每隔5秒执行一次。 | `0/5 * * * * *` |

## 表达式示例

| 表达式             | 描述                                                         | 执行时间点                                   |
| ------------------ | ------------------------------------------------------------ | -------------------------------------------- |
| `0/7 * * * * *`    | 每分钟秒数是 0或是 7 的倍数时执行一次执行                    | 每分钟第 0,7,14,21,28,35,42,49,56 秒执行     |
| `1/7 * * * * *`    | 每分钟秒数是 1 秒或（秒数-1）是 7 的倍数时执行一次           | 每分钟第 1,8,15,22,29,36,43,50,57 秒执行     |
| `*/7 * * * * *`    | 等价于 `0/7 * * * * *`                                       | -                                            |
| `1/30 * * * * *`   | 每分钟的第 1 秒和(秒数 - 1) 是 30 的倍数执行                 | 第1秒，第31秒执行，如 `12:00:01`、`12:00:31` |
| `0-15/5 * * * * *` | 每分钟的 `[0 15]` 秒区间，秒数是 0 或是 5 的倍数是执行一次   | 每分钟第 0,5,10,15 秒执行                    |
| `3-15/7 * * * * *` | 每分钟的 `[3 15]` 秒区间，秒数是 3 或是 (秒数-3) 是 7 的倍数是执行一次 | 每分钟第 3,10 秒                             |
| `3 * * * * *`      | 每分钟的第 3 秒执行一次                                      | -                                            |
| `@every 5s`        | 每 5 秒执行一次，等价于 `0/5 * * * * *`                      | -                                            |
| `@every 1h30m`     | 每一个半小时执行一次                                         | -                                            |

# 单个定时任务

```go
import (
	"fmt"
	"github.com/robfig/cron/v3"
	"time"
)

func main() {
	c := cron.New(cron.WithSeconds())
	c.AddFunc("*/7 * * * * *", func() {
		fmt.Println(time.Now().Format("2006-01-02 15:04:05"))
	})
	c.Start()
	time.Sleep(300 * time.Second)
}
```

# 多个定时任务

目录结构

```bash
.
├── job
│   ├── lunch.go
│   └── wake_up.go
└── main.go
```

创建早起任务

```go
type WakeUpJob struct {
}

func (j *WakeUpJob) Run() {
	fmt.Println(time.Now().Format("2006-01-02 15:04:05"), "起床啦...")
}
```

创建午餐任务

```go
type EatLunchJob struct {
}

func (j *EatLunchJob) Run() {
	fmt.Println(time.Now().Format("2006-01-02 15:04:05"), "结束工作，该吃午饭啦")
}
```

启动任务

```go
func main() {
	c := cron.New(cron.WithSeconds())
	wakeUpJob := &job.WakeUpJob{}
	c.AddJob("0 55 8 * * 1-5", wakeUpJob) // 周一到周五每天8:55触发一次
	lunchJob := &job.EatLunchJob{}
	c.AddJob("0 0 12 * * *", lunchJob) // 每天12:00触发一次
	c.Start()
}
```

