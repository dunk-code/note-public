## 远程调用方式

无论是微服务还是分布式服务（都是SOA，面向服务编程），都面临着服务间的远程调用

### 常见的远程调用方式

RPC：Remote Produce Call远程过程调用，类似于RMI（Remote Methods Invoke 远程方法调用，是Java中的概念，是Java十三大技术之一）。自定义数据格式，基于原生TCP通信，速度快，效率高。

- RPC：webservice、dubbo
- RMI：hessian

HTTP：http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。现在客户端浏览器与服务端通信基本都是采用http协议。也可以用来进行远程服务调用，缺点是消息封装臃肿

Rest风格就是通过http协议实现的

- http：httpClient

#### 相同点

> 底层通讯都是基于Socket，都可以实现远程调用，都可以实现服务调用服务

#### 不同点

##### RPC

> 框架有：dubbo、cxf、（RMI远程方法调用）Hessian

当使用RPC框架实现服务间调用的时候，要求服务提供方和服务消费方都必须使用统一的RPC框架，要么都Dubbo、要么都cxf

跨操作系统在统一编程语言内使用

优点：调用快、处理快

##### HTTP

> 框架有：httpClient

当使用HTTP进行服务间调用的时候，无需关注服务提供方和消费方使用的编程语言，服务方只需要提供restful风格的接口，服务消费方，按照restful的原则，请求服务

跨操作系统跨编程语言调用框架

优点：通用性强

##### 总结

1 RPC要求服务提供方和服务调用方都需要使用相同的技术，要么都hessian，要么都dubbo
而http无需关注语言的实现，只需要遵循rest规范
2 RPC的开发要求较多，像Hessian框架还需要服务器提供完整的接口代码(包名.类名.方法名必须完全一致)，否则客户端无法运行
3 Hessian只支持POST请求
4 Hessian只支持JAVA语言

## 认识RPC

RPC，即 Remote Procedure Call（远程过程调用），是一个计算机通信协议。 该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程。说得通俗一点就是：A计算机提供一个服务，B计算机可以像调用本地服务那样调用A计算机的服务。

通过上面的概念，我们可以知道，实现RPC主要是做到两点：

- 实现远程调用其他计算机服务

要实现远程调用，肯定是通过网络传输数据。A程序提供服务，B程序通过网络将请求参数传递给A，A本地执行后得到结果，再将结果返回给B程序。这里需要关注的有两点：

1. 采用何种网络通讯协议：现在比较流行的RPC框架，都会采用RPC作为底层传输协议
2. 数据传输的格式怎么样：两个程序进行通讯，必须约定好数据传输格式。就好比两个人聊天，要用同一种语言，否则无法沟通。所以，我们必须定义好请求和响应的格式。另外，数据在网路中传输需要进行序列化，所以还需要约定统一的序列化的方式

- 像调用本地服务一样调用远程服务

如果仅仅是远程调用，还不算RPC，因为RPC强调的是过程调用，用于不应该关心调用的细节，可以想调用本地服务一样调用远程服务，所以RPC一定要对调用的过程进行封装

![在这里插入图片描述](https://gitee.com/zhang-songyao/blog-images/raw/master/20210802222430.png)

## 认识HTTP

Http协议：超文本传输协议，是一种应用层协议，规定了网络传输的请求格式、响应格式、资源定位和操作方式等，但是底层采用什么网络传输协议，并没有规定，不过现在都是采用TCP协议作为底层传输协议。说到这里，大家可能觉得，Http与RPC的远程调用非常像，都是按照某种规定好的数据格式进行网络通信，有请求，有响应。没错，在这点来看，两者非常相似，但是还是有一些细微差别。

- RPC并没有规定数据传输格式，这个格式可以任意执指定，不同的RPC协议，数据格式不一定相同
- HTTP中还定义了资源定位的路径，RPC不需要
- 最重要的一点：RPC需要满足向调用本地服务一样调用远程服务，也就是调用过程在API层面进行封装，Http协议没有这样的要求，因此请求、响应等细节需要我们自己去实现。
  - 优点：RPC方式更加透明，对用户更方便。Http方式更灵活，没有规定API和语言，跨语言、跨平台
  - 缺点：RPC方式需要在API层面进行封装，限制了开发的语言环境。

![在这里插入图片描述](https://gitee.com/zhang-songyao/blog-images/raw/master/20210802230137.png)

## 如何选择

- 速度来看，RPC比HTTP要快，虽然底层都是TCP，但是HTTP协议的信息往往比较臃肿
- 难度来看，RPC实现较为复杂，HTTP相对比较简单
- 灵活性来看，HTTP更好，因为他不需要关心实现细节，跨平台、跨语言

使用场景

- 如果对效率要求更高，并且开发过程使用统一的技术栈，那么用RPC还是不错的。
- 如果需要更加灵活，跨语言、跨平台，显然http更合适

> 微服务，更加强调的是独立、自治、灵活。而RPC方式的限制较多，因此微服务框架中，一般都会采用基于Http的Rest风格服务。

# 设计RPC框架的思路

简单说一下设计一个最基本的 RPC 框架的思路：

- 注册中心 ：注册中心首先是要有的，推荐使用 Zookeeper。注册中心主要用来保存相关的信息比如远程方法的地址。
- 网络传输 ：既然要调用远程的方法就要发请求，请求中至少要包含你调用的类名、方法名以及相关参数吧！推荐基于 NIO 的 Netty 框架。
- 序列化 ：既然涉及到网络传输就一定涉及到序列化，你不可能直接使用 JDK 自带的序列化吧！JDK 自带的序列化效率低并且有安全漏洞。 所以，你还要考虑使用哪种序列化协议，比较常用的有 hession2、kyro、protostuff。
- 动态代理 ： 另外，动态代理也是需要的。因为 RPC 的主要目的就是让我们调用远程方法像调用本地方法一样简单，使用动态代理屏蔽远程接口调用的细节比如网络传输。
- 负载均衡 ：负载均衡也是需要的。为啥？举个例子我们的系统中的某个服务的访问量特别大，我们将这个服务部署在了多台服务器上，当客户端发起请求的时候，多台服务器都可以处理这个请求。那么，如何正确选择处理该请求的服务器就很关键。假如，你就要一台服务器来处理该服务的请求，那该服务部署在多台服务器的意义就不复存在了。负载均衡就是为了避免单个服务器响应同一请求，容易造成服务器宕机、崩溃等问题，我们从负载均衡的这四个字就能明显感受到它的意义。